---
id: WP05
title: Tests + CLAUDE.md
lane: planned
depends_on: [WP02, WP03, WP04]
feature: 006-multi-config-deployment
---

# WP05 — Tests + CLAUDE.md

## Goal
Update all affected tests and CLAUDE.md to reflect the new config schema, CLI interface, and removal of `git_repository_url`, then verify the full test suite passes and both grep audits return zero matches.

## Context
- Upstream-first: clean PR to around-the-grounds main
- Minimalism: only config loading and CLI surface changes — no parser/scraper logic changes
- Prerequisite: spec 004 merged before implementing
- Branch: `006-multi-config-deployment`
- Depends on WP02, WP03, WP04 — implement last; blocks nothing

## Subtasks
- [ ] Update `tests/conftest.py`: rename `test_breweries_config` fixture → `test_venues_config`; add `list_name`, `target_repo`, `target_branch`, `target_url`; rename `"breweries"` key → `"venues"`; add `source_type` and `timezone` per entry
- [ ] Update `tests/fixtures/config/test_breweries.json`: apply same schema migration (rename key, add top-level fields, add per-venue `source_type` and `timezone`)
- [ ] Update `tests/integration/test_cli.py`:
  - Remove `load_brewery_config` import
  - Change all `main(["--config", path])` → `main([path])`
  - Change all `main(["--config", path, "--verbose"])` → `main([path, "--verbose"])`
  - `test_main_help_flag`: assert `"venues_config"` in help text, not `"--config"`
  - `test_main_default_config`: rewrite — `main([])` now exits with argparse error (code 2), not a file-not-found error
  - Rename `test_load_brewery_config_*` tests → `test_load_venue_list_*` (schema validation, missing fields)
  - `test_scrape_food_trucks_no_breweries`: update empty venues fixture (schema requires `minItems: 1`; use a fixture with at least 1 venue)
- [ ] Update `tests/temporal/test_workflows.py`:
  - Remove assertion `params.git_repository_url == DEFAULT_GIT_REPOSITORY`
  - Remove `DEFAULT_GIT_REPOSITORY` import
- [ ] Update `tests/temporal/test_activities.py`:
  - Update patching target from `load_brewery_config` to `load_venue_list`
- [ ] Create `tests/unit/test_config_loader.py` with:
  - `test_load_venue_list_valid`: valid config returns correct `VenueList` fields
  - `test_load_venue_list_missing_target_repo`: raises `ConfigValidationError` with field name in message
  - `test_load_venue_list_missing_file`: raises `FileNotFoundError`
  - `test_load_venue_list_default_branch`: `target_branch` defaults to `"main"` when omitted
  - `test_resolve_template_dir_default`: returns path to built-in `public_template/` when `template_dir` is None
  - `test_resolve_template_dir_custom`: resolves custom `template_dir` relative to config file location
- [ ] Update `CLAUDE.md` "Running the Application" section to new CLI syntax:
  - Replace `uv run around-the-grounds` → `uv run around-the-grounds around_the_grounds/config/breweries.json`
  - Replace `uv run around-the-grounds --deploy` → `uv run around-the-grounds around_the_grounds/config/breweries.json --deploy`
  - Replace `uv run around-the-grounds --preview` → `uv run around-the-grounds around_the_grounds/config/breweries.json --preview`
  - Replace `uv run around-the-grounds --config /path/to/config.json` → `uv run around-the-grounds /path/to/config.json`
  - Remove references to `--git-repo` and `GIT_REPOSITORY_URL`
- [ ] Run audit: `grep -r "DEFAULT_GIT_REPOSITORY\|get_git_repository_url\|GIT_REPOSITORY_URL" around_the_grounds/` → zero matches
- [ ] Run audit: `grep -r "Path.cwd.*public_template" around_the_grounds/` → zero matches
- [ ] Run full test suite: `uv run python -m pytest` — all tests pass

## Files to change
- `tests/conftest.py` — update `test_breweries_config` fixture shape and name
- `tests/fixtures/config/test_breweries.json` — migrate to new schema shape
- `tests/integration/test_cli.py` — CLI invocation updates, rename load tests
- `tests/temporal/test_workflows.py` — remove `git_repository_url` assertions
- `tests/temporal/test_activities.py` — update mock patch target
- `tests/unit/test_config_loader.py` — new file with loader unit tests
- `CLAUDE.md` — update running commands to new CLI syntax

## Acceptance criteria
- `uv run python -m pytest` — all tests pass (196+ tests)
- `grep -r "DEFAULT_GIT_REPOSITORY\|get_git_repository_url\|GIT_REPOSITORY_URL" around_the_grounds/` → zero matches
- `grep -r "Path.cwd.*public_template" around_the_grounds/` → zero matches
- `grep -rn '"main"' around_the_grounds/` — no hardcoded branch strings remain in git push calls
- `Brewery` model diff is empty (no changes to `models/brewery.py`)
- `parsers/registry.py` diff is empty (no changes to parser dispatch logic)

## Reviewer notes
- `test_scrape_food_trucks_no_breweries` requires re-thinking: the new schema enforces `minItems: 1` on `venues`, so an empty-venues fixture is no longer schema-valid; either mock `load_venue_list` to return an empty list directly, or remove this test if it was testing a now-impossible state
- The `test_main_default_config` rewrite is significant: previously `main([])` loaded a default config path; now it exits with argparse error code 2 because `venues_config` is a required positional arg
- `CLAUDE.md` updates must reflect the new positional arg syntax in all example commands, including the Temporal/scheduled run examples
