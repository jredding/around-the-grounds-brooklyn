---
id: WP03
title: Update main.py
lane: planned
depends_on: [WP01]
feature: 006-multi-config-deployment
---

# WP03 — Update main.py

## Goal
Replace the `--config`/`--git-repo` CLI flags and `load_brewery_config()` function with a required positional `venues_config` argument and `load_venue_list()`, threading `target_repo`, `target_branch`, and `template_dir` from the config file through the deploy and preview paths.

## Context
- Upstream-first: clean PR to around-the-grounds main
- Minimalism: only config loading and CLI surface changes — no parser/scraper logic changes
- Prerequisite: spec 004 merged before implementing
- Branch: `006-multi-config-deployment`
- Depends on WP01; can be developed in parallel with WP02; blocks WP04 and WP05

## Subtasks
- [ ] Remove import `from .config.settings import get_git_repository_url`
- [ ] Add import `from .config.loader import ConfigValidationError, VenueList, load_venue_list`
- [ ] Remove `load_brewery_config()` function entirely
- [ ] Add `_resolve_template_dir(venue_list: VenueList, config_path: str) -> Path` helper:
  - If `venue_list.template_dir` is set, resolve it relative to the config file's parent directory
  - Otherwise return `Path(__file__).parent.parent / "public_template"`
- [ ] Update `async_main()`: call `load_venue_list(args.venues_config)` once, pass `venue_list.venues` to `scrape_food_trucks()`
- [ ] Update `deploy_to_web()` signature: accept `venue_list: VenueList` instead of `git_repo_url`; derive `repository_url`, `target_branch`, `template_dir` from `venue_list`
- [ ] Update `_deploy_with_github_auth()` signature: add `target_branch: str` and `template_dir: Path` parameters
- [ ] Replace `Path.cwd() / "public_template"` in `_deploy_with_github_auth()` with `template_dir`
- [ ] Replace hardcoded `["git", "push", "origin", "main"]` in `_deploy_with_github_auth()` with `["git", "push", "origin", target_branch]`
- [ ] Update `preview_locally()` signature: add `template_dir: Path` parameter
- [ ] Replace `Path.cwd() / "public_template"` in `preview_locally()` with `template_dir`
- [ ] Update argparse in `main()`: remove `--config`/`-c` argument; remove `--git-repo` argument; add `venues_config` as a required positional argument
- [ ] Keep `--deploy`, `--preview`, `--verbose`, `--version` flags unchanged
- [ ] Let `ConfigValidationError` and `FileNotFoundError` from `load_venue_list` propagate to the existing outer `try/except` in `main()` — no new error handling needed

## Files to change
- `around_the_grounds/main.py` — primary changes (imports, functions, argparse)

## Acceptance criteria
- `uv run around-the-grounds --help` shows `venues_config` as a required positional argument
- `uv run around-the-grounds --help` does NOT show `--config` or `--git-repo`
- `grep "Path.cwd.*public_template" around_the_grounds/main.py` → zero matches
- `grep "get_git_repository_url" around_the_grounds/main.py` → zero matches
- `grep '"main"' around_the_grounds/main.py` → no hardcoded branch strings remain in git push calls

## Reviewer notes
- Core git deploy logic in `_deploy_with_github_auth()` is unchanged — only the signature and two variable substitutions (`template_dir`, `target_branch`)
- `generate_web_data()` function is unchanged
- GitHub App auth logic is unchanged
- `ANTHROPIC_API_KEY` usage is unchanged
- `ConfigValidationError` and `FileNotFoundError` should propagate naturally without new try/except blocks
